<!DOCTYPE html>
<html lang="es"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Uni√≥n Exitosa - PurrCrafter</title>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1897264775520223"
     crossorigin="anonymous"></script>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<style type="text/tailwindcss">
        :root {
            --bg-color: #FFFFFF;
            --text-color: #1F2937;
            --primary-color: #2563EB;
            --secondary-color: #F9FAFB;
            --accent-color: #3B82F6;
            --border-color: #E5E7EB;
            --text-muted-color: #6B7280;
            --success-color: #10B981;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        .purr-button {
            transition: all 0.3s ease-in-out;
            background-color: var(--primary-color);
        }
        .purr-button:hover:not(:disabled) {
            transform: scale(1.05);
            background-color: var(--accent-color);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
        }
        .secondary-button {
            transition: all 0.3s ease-in-out;
        }
        .secondary-button:hover {
            background-color: #F3F4F6;
            color: var(--accent-color);
        }
        .check-icon {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: block;
            stroke-width: 4;
            stroke: var(--success-color);
            stroke-miterlimit: 10;
            box-shadow: inset 0px 0px 0px #10B981;
            animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
            margin: 0 auto;
        }
        .check-icon__circle {
            stroke-dasharray: 377px, 377px;
            stroke-dashoffset: 377px;
            stroke-linecap: round;
            animation: stroke .6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }
        .check-icon__check {
            transform-origin: 50% 50%;
            stroke-dasharray: 100;
            stroke-dashoffset: 100;
            animation: stroke .3s cubic-bezier(0.65, 0, 0.45, 1) .8s forwards;
        }
        @keyframes stroke {
            100% {
                stroke-dashoffset: 0;
            }
        }
        @keyframes scale {
            0%, 100% {
                transform: none;
            }
            50% {
                transform: scale3d(1.1, 1.1, 1);
            }
        }
        @keyframes fill {
            100% {
                box-shadow: inset 0px 0px 0px 60px var(--success-color);
                stroke: #fff;
            }
        }
    </style>
</head>
<body class="antialiased">
<div class="container mx-auto px-4 min-h-screen flex flex-col items-center justify-center pt-10">
<main class="w-full max-w-2xl flex-grow flex flex-col items-center justify-center text-center">
<div class="bg-[var(--secondary-color)] rounded-2xl border border-[var(--border-color)] p-8 md:p-12 shadow-sm w-full">
<div class="flex justify-center items-center">
<svg class="check-icon" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
<circle class="check-icon__circle" cx="60" cy="60" fill="none" r="58"></circle>
<polyline class="check-icon__check" fill="none" points="35,60 52,77 85,44"></polyline>
</svg>
</div>
<h1 id="success-title" class="text-3xl md:text-4xl font-bold text-[var(--text-color)] mt-6">¬°PDFs Unidos Exitosamente!</h1>
<p id="success-description" class="text-lg text-[var(--text-muted-color)] mt-2">Tu nuevo documento est√° listo para ser descargado.</p>
<div class="mt-10">
<button id="download-button" class="w-full max-w-sm purr-button text-white px-8 py-4 rounded-xl font-semibold text-xl shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 focus:ring-[var(--accent-color)] flex items-center justify-center mx-auto min-h-[64px]">
<span class="material-symbols-outlined mr-2">download</span>
<span>Descargar PDF Unido</span>
</button>
</div>

<!-- Bloque de anuncios AdSense -->
<div class="mt-8 mb-8 flex justify-center">
    <!-- PurrCrafter -->
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-1897264775520223"
         data-ad-slot="2473509960"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>

<div class="mt-8 pt-6 border-t border-[var(--border-color)] flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-6">
<a class="secondary-button text-[var(--text-muted-color)] font-medium px-4 py-2 rounded-lg flex items-center space-x-2" href="index.html">
<span class="material-symbols-outlined">home</span>
<span>Volver a la P√°gina Principal</span>
</a>
<a class="secondary-button text-[var(--text-muted-color)] font-medium px-4 py-2 rounded-lg flex items-center space-x-2" href="index.html">
<span class="material-symbols-outlined">add_circle</span>
<span>Unir Otro PDF</span>
</a>
</div>
</div>
</main>
<footer class="w-full max-w-4xl py-8 mt-12 text-center text-sm text-[var(--text-muted-color)]">
<div class="flex justify-center space-x-6 mb-4">
<a class="hover:text-[var(--accent-color)] transition-colors" href="terminos.html">T√©rminos y Condiciones</a>
<a class="hover:text-[var(--accent-color)] transition-colors" href="privacidad.html">Privacidad</a>
<a class="hover:text-[var(--accent-color)] transition-colors" href="#contacto">Contacto</a>
</div>
<p>¬© 2025 PurrCrafter. Todos los derechos reservados.</p>
</footer>
</div>

<script>
    const API = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
        ? 'http://localhost:3002' 
        : 'https://api-oculto-9k7s.aaleddy.app';

    const downloadButton = document.getElementById('download-button');
    let workspaceId = null;

    // Detectar Safari iOS
    function isSafariIOS() {
        const ua = navigator.userAgent;
        const iOS = /iPad|iPhone|iPod/.test(ua);
        const webkit = /WebKit/.test(ua);
        return iOS && webkit && !/(CriOS|FxiOS|OPiOS|mercury)/i.test(ua);
    }

    // Recuperar workspace ID de la sesi√≥n
    function loadSessionData() {
        workspaceId = sessionStorage.getItem('workspaceId');
        const operationType = sessionStorage.getItem('operationType') || 'unir';
        
        console.log('üîç Datos de sesi√≥n encontrados:');
        console.log('  workspaceId:', workspaceId);
        console.log('  downloadUrl:', sessionStorage.getItem('downloadUrl'));
        console.log('  filename:', sessionStorage.getItem('filename'));
        console.log('  operationType:', operationType);
        
        // Personalizar el contenido seg√∫n el tipo de operaci√≥n
        const titleElement = document.getElementById('success-title');
        const descriptionElement = document.getElementById('success-description');
        const downloadButton = document.getElementById('download-button');
        
        if (operationType === 'redimensionar') {
            titleElement.textContent = '¬°PDF Redimensionado Exitosamente!';
            descriptionElement.textContent = 'Tu PDF redimensionado est√° listo para ser descargado.';
            downloadButton.innerHTML = '<span class="material-symbols-outlined mr-2">download</span><span>Descargar PDF Redimensionado</span>';
        } else {
            titleElement.textContent = '¬°PDFs Unidos Exitosamente!';
            descriptionElement.textContent = 'Tu nuevo documento est√° listo para ser descargado.';
            downloadButton.innerHTML = '<span class="material-symbols-outlined mr-2">download</span><span>Descargar PDF Unido</span>';
        }
        
        // Obtener URL de descarga real si est√° disponible
        const downloadUrl = sessionStorage.getItem('downloadUrl');
        if (downloadUrl) {
            console.log('üì• URL de descarga encontrada:', downloadUrl);
        }
        
        if (!workspaceId) {
            console.error('‚ùå No se encontr√≥ workspace ID en sessionStorage');
            alert('No se encontr√≥ informaci√≥n de la sesi√≥n. Redirigiendo al inicio.');
            window.location.href = 'index.html';
            return;
        }
        
        console.log('‚úÖ Datos de sesi√≥n cargados correctamente');
    }

    // Descargar el PDF generado
    async function downloadMergedPDF() {
        if (!workspaceId) {
            console.error('‚ùå No se encontr√≥ el workspace ID');
            alert('Error: No se encontr√≥ el workspace ID.');
            return;
        }

        try {
            downloadButton.disabled = true;
            downloadButton.innerHTML = '<span class="material-symbols-outlined mr-2">download</span><span>Descargando...</span>';
            
            // Usar URL de descarga guardada o construir la URL por defecto
            let downloadUrl = sessionStorage.getItem('downloadUrl');
            if (downloadUrl) {
                // URL relativa del API, necesitamos hacer la URL completa
                downloadUrl = `${API}${downloadUrl}`;
            } else {
                // Fallback a la URL por defecto (por si acaso)
                console.warn('‚ö†Ô∏è No hay downloadUrl en sessionStorage, usando fallback');
                downloadUrl = `${API}/workspaces/${workspaceId}/download/resultado_nombre.pdf`;
            }
            
            console.log('üîó URL de descarga final:', downloadUrl);
            console.log('üîó API base:', API);
            console.log('üîó Workspace ID:', workspaceId);
            
            // Manejo espec√≠fico para Safari iOS
            if (isSafariIOS()) {
                console.log('üì± Safari iOS detectado - intentando descarga forzada');
                
                const filename = sessionStorage.getItem('filename') || 'PDF-Redimensionado.pdf';
                
                // M√©todo 1: Intentar fetch + blob + download
                try {
                    console.log('üîÑ Intentando descarga via fetch...');
                    downloadButton.innerHTML = '<span class="material-symbols-outlined mr-2">download</span><span>Descargando...</span>';
                    
                    const response = await fetch(downloadUrl);
                    if (!response.ok) throw new Error('Error en la respuesta del servidor');
                    
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    
                    // Crear enlace con download forzado
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.style.display = 'none';
                    
                    // M√∫ltiples intentos de forzar descarga en iOS
                    document.body.appendChild(link);
                    
                    // Simular click del usuario
                    const clickEvent = new MouseEvent('click', {
                        bubbles: true,
                        cancelable: true,
                        view: window
                    });
                    
                    link.dispatchEvent(clickEvent);
                    
                    // Cleanup
                    setTimeout(() => {
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                    }, 100);
                    
                    console.log('‚úÖ Descarga forzada iniciada en Safari iOS');
                    
                } catch (fetchError) {
                    console.warn('‚ö†Ô∏è Fetch fall√≥, usando m√©todo alternativo:', fetchError);
                    
                    // M√©todo 2: Fallback - ventana con headers especiales
                    const link = document.createElement('a');
                    link.href = downloadUrl + '?download=1&force=true';
                    link.download = filename;
                    link.target = '_self'; // Mismo frame para forzar descarga
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Mostrar mensaje solo si fallan ambos m√©todos
                    setTimeout(() => {
                        alert(`üì± Si el archivo se abre en el navegador:\n\n1. Toca el bot√≥n "Compartir" ‚ÜóÔ∏è\n2. Selecciona "Guardar en Archivos" üíæ\n3. Elige la ubicaci√≥n para guardar\n\nNombre: ${filename}`);
                    }, 2000);
                }
                
            } else {
                console.log('üíª Navegador desktop/m√≥vil compatible - descarga directa');
                
                // M√©todo normal para otros navegadores
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = sessionStorage.getItem('filename') || 'PDFs-Unidos-PurrCrafter.pdf';
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            console.log('‚úÖ Descarga iniciada exitosamente');
            
            // Restablecer bot√≥n despu√©s de un momento
            setTimeout(() => {
                downloadButton.disabled = false;
                
                // Texto del bot√≥n dependiendo del dispositivo y tipo de operaci√≥n
                const operationType = sessionStorage.getItem('operationType') || 'unir';
                if (isSafariIOS()) {
                    if (operationType === 'redimensionar') {
                        downloadButton.innerHTML = '<span class="material-symbols-outlined mr-2">open_in_new</span><span>Abrir PDF Redimensionado</span>';
                    } else {
                        downloadButton.innerHTML = '<span class="material-symbols-outlined mr-2">open_in_new</span><span>Abrir PDF Unido</span>';
                    }
                } else {
                    if (operationType === 'redimensionar') {
                        downloadButton.innerHTML = '<span class="material-symbols-outlined mr-2">download</span><span>Descargar PDF Redimensionado</span>';
                    } else {
                        downloadButton.innerHTML = '<span class="material-symbols-outlined mr-2">download</span><span>Descargar PDF Unido</span>';
                    }
                }
            }, 2000);

        } catch (error) {
            console.error('‚ùå Error al descargar:', error);
            alert(`Error al descargar el archivo: ${error.message}. Por favor, int√©ntalo de nuevo.`);
            
            downloadButton.disabled = false;
            
            // Restablecer texto del bot√≥n seg√∫n dispositivo y operaci√≥n
            const operationType = sessionStorage.getItem('operationType') || 'unir';
            if (isSafariIOS()) {
                if (operationType === 'redimensionar') {
                    downloadButton.innerHTML = '<span class="material-symbols-outlined mr-2">open_in_new</span><span>Abrir PDF Redimensionado</span>';
                } else {
                    downloadButton.innerHTML = '<span class="material-symbols-outlined mr-2">open_in_new</span><span>Abrir PDF Unido</span>';
                }
            } else {
                if (operationType === 'redimensionar') {
                    downloadButton.innerHTML = '<span class="material-symbols-outlined mr-2">download</span><span>Descargar PDF Redimensionado</span>';
                } else {
                    downloadButton.innerHTML = '<span class="material-symbols-outlined mr-2">download</span><span>Descargar PDF Unido</span>';
                }
            }
        }
    }

    // Event listeners
    downloadButton.addEventListener('click', downloadMergedPDF);

    // Cargar datos al iniciar
    loadSessionData();
</script>

</body></html>