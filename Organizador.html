<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Unir PDFs por MIA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;max-width:800px;margin:24px auto;padding:0 14px}
    h1{margin:6px 0 16px}
    section{border:1px solid #ddd;border-radius:12px;padding:16px;margin:14px 0;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    label{display:block;margin:8px 0 6px}
    input[type="text"],textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:10px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>*{flex:1}
    button{padding:10px 14px;border:0;border-radius:10px;background:#2563eb;color:#fff;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    progress{width:100%;height:14px}
    .muted{color:#666}.ok{color:#16a34a}.err{color:#b91c1c}
    .mode-info{background:#e7f3ff;border:1px solid #b3d9ff;border-radius:8px;padding:12px;margin:8px 0;font-size:14px}
  </style>
</head>
<body>
  <h1>Unir PDFs por MIA</h1>

  <section>
    <label>Modo de unión</label>
    <label><input type="radio" name="mode" value="filename" checked> Por nombre de archivo (recomendado)</label>
    <label><input type="radio" name="mode" value="content"> Por contenido del PDF</label>
    <label><input type="radio" name="mode" value="both"> Híbrido (nombre + contenido)</label>
    
    <div id="modeInfo" class="mode-info">
      <strong>Modo actual:</strong> Por nombre de archivo
      <br><em>Busca códigos MIA en los nombres de los archivos PDF. Es más rápido y confiable.</em>
    </div>
  </section>

  <section>
    <label>Seleccionar PDFs (muchos a la vez)</label>
    <input id="files" type="file" accept="application/pdf" multiple />
    <div class="row" style="align-items:center;margin-top:8px">
      <button id="btnGenerate">Subir y generar PDF</button>
      <div id="status" class="muted"></div>
    </div>
    <progress id="bar" max="100" value="0"></progress>
  </section>

  <section>
    <label>Orden de CÓDIGOS (MIA) — uno por línea</label>
    <textarea id="codes" rows="5" placeholder="MIA000044043205&#10;000044043206&#10;MIA784587451"></textarea>
    <div class="muted">Puedes escribir solo números (ej: 000044043205) o el código completo (MIA000044043205)</div>
  </section>

  <section>
    <label>Nombre del PDF final</label>
    <input id="outName" type="text" value="resultado.pdf">
    <div id="result" style="margin-top:10px"></div>
  </section>

  <script>
    const API = 'https://api-oculto-9k7s.aaleddy.app';
    const $ = id => document.getElementById(id);
    const mode = () => document.querySelector('input[name="mode"]:checked').value;

    // Actualizar información del modo cuando cambia
    document.querySelectorAll('input[name="mode"]').forEach(radio => {
      radio.addEventListener('change', updateModeInfo);
    });

    function updateModeInfo() {
      const selectedMode = mode();
      const modeInfo = $('modeInfo');
      
      switch(selectedMode) {
        case 'filename':
          modeInfo.innerHTML = '<strong>Modo actual:</strong> Por nombre de archivo<br><em>Busca códigos MIA en los nombres de los archivos PDF. Es más rápido y confiable.</em>';
          break;
        case 'content':
          modeInfo.innerHTML = '<strong>Modo actual:</strong> Por contenido del PDF<br><em>Busca códigos MIA dentro del texto de los PDFs. Más lento pero útil si los nombres no tienen códigos.</em>';
          break;
        case 'both':
          modeInfo.innerHTML = '<strong>Modo actual:</strong> Híbrido (nombre + contenido)<br><em>Combina ambos métodos para máxima cobertura. El más completo pero también el más lento.</em>';
          break;
      }
    }

    const normalize = s => {
      s = (s || '').toUpperCase().trim().replace(/[\s_-]+/g, '');
      if (!s) return '';
      if (!s.startsWith('MIA') && /^\d+$/.test(s)) s = 'MIA' + s;
      return s;
    };

    async function createWorkspace(){ 
      const r = await fetch(API+'/workspaces', {method:'POST'}); 
      return (await r.json()).workspace_id; 
    }

    function uploadWithProgress(url, formData, onProgress){
      return new Promise((resolve, reject)=>{
        const xhr = new XMLHttpRequest(); 
        xhr.open('POST', url);
        xhr.upload.onprogress = e => { 
          if(e.lengthComputable && onProgress){ 
            onProgress(Math.round((e.loaded/e.total)*100), e.loaded, e.total); 
          } 
        };
        xhr.onload = () => { 
          try{ 
            resolve(JSON.parse(xhr.responseText)); 
          }catch{ 
            resolve({raw:xhr.responseText}); 
          } 
        };
        xhr.onerror = () => reject(new Error('Network error')); 
        xhr.send(formData);
      });
    }

    async function buildIndex(ws_id, scan_mode){
      let body;
      switch(scan_mode) {
        case 'filename':
          body = { 
            scan_mode: 'filename', 
            max_pages: 10000 
          };
          break;
        case 'content':
          body = { 
            scan_mode: 'content', 
            pattern: '\\bMIA[-_ ]?\\d{1,}[A-Za-z0-9]*\\b', 
            max_pages: 10000 
          };
          break;
        case 'both':
          body = { 
            scan_mode: 'both', 
            pattern: '\\bMIA[-_ ]?\\d{1,}[A-Za-z0-9]*\\b', 
            max_pages: 10000 
          };
          break;
        default:
          throw new Error(`Modo no válido: ${scan_mode}`);
      }
      
      const r = await fetch(`${API}/workspaces/${ws_id}/index`, { 
        method: 'POST', 
        headers: {'Content-Type': 'application/json'}, 
        body: JSON.stringify(body) 
      });
      
      if (!r.ok) {
        const errorText = await r.text();
        throw new Error(`Error ${r.status}: ${errorText}`);
      }
      
      return r.json();
    }

    async function mergeByCode(ws_id, order, scan_mode, output){
      const payload = {
        order,
        output_name: output || 'resultado.pdf',
        on_missing: 'skip',
        source_filter: (scan_mode === 'filename') ? 'filename' : 
                      (scan_mode === 'content') ? 'content' : 'any',
        filename_behavior: (scan_mode === 'filename') ? 'entire_pdf' : 'first_page',
        pages_per_code: 'first'
      };
      
      const r = await fetch(`${API}/workspaces/${ws_id}/merge-by-code`, { 
        method: 'POST', 
        headers: {'Content-Type': 'application/json'}, 
        body: JSON.stringify(payload) 
      });
      
      if (!r.ok) {
        const errorText = await r.text();
        throw new Error(`Error ${r.status}: ${errorText}`);
      }
      
      return r.json();
    }

    $('btnGenerate').onclick = async () => {
      const files = $('files').files;
      if (!files.length) { alert('Selecciona uno o más PDFs.'); return; }

      let order = $('codes').value.split(/\r?\n/).map(normalize).filter(Boolean);
      if (!order.length) { alert('Ingresa el orden de códigos (MIA).'); return; }

      const outName = $('outName').value.trim() || 'resultado.pdf';
      const scan_mode = mode();

      $('status').textContent = 'Creando carpeta...'; 
      $('bar').value = 0; 
      $('btnGenerate').disabled = true;

      try {
        const ws_id = await createWorkspace();

        const fd = new FormData(); 
        for (const f of files) fd.append('files', f);
        
        $('status').textContent = 'Subiendo...';
        const upRes = await uploadWithProgress(`${API}/workspaces/${ws_id}/upload`, fd,
          (pct, loaded, total) => { 
            $('bar').value = pct; 
            $('status').textContent = `Subiendo ${pct}% (${Math.round(loaded/1e6)} / ${Math.round(total/1e6)} MB)`; 
          }
        );
        
        if (!upRes || !upRes.count) throw new Error('No se pudieron subir los archivos.');

        $('status').textContent = 'Indexando...';
        await buildIndex(ws_id, scan_mode);

        $('status').textContent = 'Generando PDF...';
        const merge = await mergeByCode(ws_id, order, scan_mode, outName);
        
        if (!merge.ok) throw new Error(JSON.stringify(merge));

        $('status').innerHTML = `<span class="ok">✓ Completado</span> — ${merge.pages} página(s).`;
        $('bar').value = 100;
        $('result').innerHTML = `<strong>Descarga:</strong> <a href="${API}${merge.download_url}" target="_blank" rel="noopener">${merge.output}</a>`;
        
      } catch (e) {
        const errorMsg = e.message || e;
        $('status').innerHTML = `<span class="err">❌ Error:</span> ${errorMsg}`;
      } finally {
        $('btnGenerate').disabled = false;
      }
    };

    // Inicializar la información del modo
    updateModeInfo();
  </script>
</body>
</html>
