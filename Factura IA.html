<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Maqueta de Factura - PurrCrafter</title>
    
    <!-- PWA metas -->
    <meta name="theme-color" content="#ffffff"/>
    <meta name="mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="default"/>
    <meta name="apple-mobile-web-app-title" content="PurrCrafter"/>

    <!-- AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1897264775520223" crossorigin="anonymous"></script>

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style type="text/tailwindcss">
        :root {
            --bg-color: #F9FAFB;
            --text-color: #1F2937;
            --primary-color: #2563EB;
            --secondary-color: #FFFFFF;
            --accent-color: #3B82F6;
            --border-color: #E5E7EB;
            --text-muted-color: #6B7280;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        .input-field { 
            width: 100%; 
            padding: 12px 16px; 
            border-radius: 8px; 
            background-color: white; 
            border: 1px solid #d1d5db; 
            outline: none; 
            transition: all 0.3s ease-in-out; 
        }
        .input-field:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--accent-color);
            border-color: transparent;
        }
        .input-label { 
            display: block; 
            font-size: 0.875rem; 
            font-weight: 500; 
            color: var(--text-muted-color); 
            margin-bottom: 4px; 
        }
        .purr-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 32px;
            font-weight: 600;
        }
        .purr-button:hover {
            transform: translateY(-2px);
            background-color: var(--accent-color);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
        }
        .secondary-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background-color: var(--secondary-color);
            color: var(--text-muted-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px 32px;
        }
        .secondary-button:hover {
            background-color: #f7f8f8;
            border-color: #c7c7c7;
            transform: translateY(-2px);
        }
        .invoice-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border: 1px solid #ddd;
        }
        
        .print-hidden {
            display: block;
        }
        
        .invoice-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border: 1px solid #ddd;
        }
        
        .print-hidden {
            display: block;
        }
        
        textarea {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
        }
        
        textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .status {
            padding: 10px 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        
        .hidden {
            display: none;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            
            .invoice-preview, .invoice-preview * {
                visibility: visible;
            }
            
            .invoice-preview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            
            .print-hidden {
                display: none !important;
            }
            
            .invoice-container {
                border: none;
                box-shadow: none;
                max-width: 100%;
            }
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .invoice-preview, .invoice-preview * {
                visibility: visible;
            }
            .invoice-preview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .print-hidden {
                display: none !important;
            }
            .invoice-container {
                border: none;
                box-shadow: none;
                max-width: 100%;
            }
        }
    </style>
</head>

<body class="antialiased">
<div class="container mx-auto px-4 min-h-screen flex flex-col items-center pt-10">
<header class="text-center w-full max-w-4xl mb-8">
    <a class="inline-block mb-6 text-[var(--primary-color)] hover:text-[var(--accent-color)] transition-colors" href="index.html">
        <div class="flex items-center space-x-2">
            <span class="material-symbols-outlined">
                arrow_back
            </span>
            <span>Volver a Inicio</span>
        </div>
    </a>
    <h1 class="text-4xl md:text-5xl font-bold text-[var(--text-color)] drop-shadow-sm">Crear Factura desde JSON</h1>
    <p class="text-lg text-[var(--text-muted-color)] mt-2">Se genera factura mediante JSON creado por inteligencia artificial.</p>
</header>

<!-- Bloque de anuncios AdSense superior -->
<div class="w-full max-w-4xl mb-8 flex justify-center print-hidden">
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-1897264775520223"
         data-ad-slot="2473509960"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>

<!-- Explicación de Uso -->
<div class="w-full max-w-4xl mb-8 bg-blue-50 border border-blue-200 rounded-xl p-6">
    <h2 class="text-xl font-semibold text-blue-800 mb-4 flex items-center">
        <span class="material-symbols-outlined mr-2">info</span>
        ¿Cómo usar esta herramienta?
    </h2>
    <div class="space-y-3 text-blue-700">
        <p><strong>Paso 1:</strong> Haz clic en "Copiar Prompt" para obtener las instrucciones para la IA.</p>
        <p><strong>Paso 2:</strong> Ve a tu IA de preferencia (ChatGPT, Claude, Gemini, etc.) y pega el prompt.</p>
        <p><strong>Paso 3:</strong> En el mismo mensaje, adjunta tus documentos: PDFs de facturas, capturas de pantalla o fotos.</p>
        <p><strong>Paso 4:</strong> La IA te dará un JSON ordenado. Copia ese resultado y pégalo en el campo de texto de abajo.</p>
        <p><strong>Paso 5:</strong> Haz clic en "Generar Factura" y podrás editarlo antes de descargar el PDF final.</p>
    </div>
</div>

<main class="max-w-4xl mx-auto">

    <div id="form-step-1" class="step-container">
        <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8 md:p-10">
            <form class="space-y-6">
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="input-label" for="json-input">Contenido JSON de la Factura</label>
                        <button class="flex items-center space-x-2 text-sm text-[var(--primary-color)] font-medium" type="button" onclick="copyJsonToClipboard()">
                            <span class="material-symbols-outlined text-base">content_copy</span>
                            <span>Copiar Prompt</span>
                        </button>
                    </div>
                    <textarea class="input-field min-h-[250px] font-mono text-sm" id="json-input" placeholder='Pega tu JSON aquí...'></textarea>
                </div>
                <div class="flex justify-center pt-4">
                    <button id="generate-button" class="px-8 py-3 rounded-xl font-semibold text-white purr-button w-full sm:w-auto" type="button" onclick="generateInvoice()">Generar Factura</button>
                </div>
            </form>
        </div>
    </div>

    <div id="form-step-2" class="step-container hidden">
        <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8 md:p-10">
            <form class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="input-label" for="order-number">Número de Pedido</label>
                        <input type="text" id="order-number" class="input-field" value="PO-20251002-1">
                    </div>
                    <div>
                        <label class="input-label" for="order-date">Fecha de Pedido</label>
                        <input type="date" id="order-date" class="input-field" value="2025-10-02">
                    </div>
                </div>
                <div>
                    <label class="input-label" for="client-name">Nombre del Cliente</label>
                    <input type="text" id="client-name" class="input-field" value="Cliente Desconocido">
                </div>

                <div class="space-y-4 pt-2">
                    <label class="input-label !text-base !font-semibold !text-gray-700 !mb-2">Dirección de Envío</label>
                    <input type="text" id="direccion" class="input-field" placeholder="Dirección" value="Dirección Desconocida">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <input type="text" id="ciudad" class="input-field" placeholder="Ciudad" value="Ciudad Desconocida">
                        <input type="text" id="estado" class="input-field" placeholder="Estado" value="Estado Desconocido">
                        <input type="text" id="codigo-postal" class="input-field" placeholder="Código Postal" value="00000">
                        <input type="text" id="pais" class="input-field" placeholder="País" value="País Desconocido">
                    </div>
                </div>

                <div class="space-y-4 pt-2">
                    <label class="input-label !text-base !font-semibold !text-gray-700 !mb-2">Productos Comprados</label>
                    <div id="productos-container">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 producto-row">
                            <input type="text" class="input-field md:col-span-3 producto-nombre" placeholder="Nombre del producto" value="Buffet Risers with Mini Signs, Food Ri">
                            <input type="number" class="input-field producto-cantidad" placeholder="Cantidad" value="1" min="1">
                            <div class="flex items-center space-x-2">
                                <input type="number" class="input-field producto-precio" placeholder="Precio" value="49.98" min="0" step="0.01">
                                <button type="button" class="text-gray-400 hover:text-red-500 eliminar-producto" onclick="eliminarProducto(this)"><span class="material-symbols-outlined">delete</span></button>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 producto-row">
                            <input type="text" class="input-field md:col-span-3 producto-nombre" placeholder="Nombre del producto" value="Distressed Champagne Metal Com">
                            <input type="number" class="input-field producto-cantidad" placeholder="Cantidad" value="1" min="1">
                            <div class="flex items-center space-x-2">
                                <input type="number" class="input-field producto-precio" placeholder="Precio" value="26.95" min="0" step="0.01">
                                <button type="button" class="text-gray-400 hover:text-red-500 eliminar-producto" onclick="eliminarProducto(this)"><span class="material-symbols-outlined">delete</span></button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="flex items-center space-x-2 text-[var(--primary-color)] hover:text-[var(--accent-color)] font-medium pt-2" onclick="agregarProducto()">
                        <span class="material-symbols-outlined">add_circle</span>
                        <span>Agregar más productos</span>
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-2">
                    <div>
                        <label class="input-label" for="shipping-cost">Costo de Envío ($)</label>
                        <input type="text" id="shipping-cost" class="input-field" value="5.99">
                    </div>
                    <div>
                        <label class="input-label" for="shipping-method">Método de Envío</label>
                        <input type="text" id="shipping-method" class="input-field" value="Envío Estándar">
                    </div>
                     <div>
                        <label class="input-label" for="delivery-date">Fecha de Envío</label>
                        <input type="date" id="delivery-date" class="input-field" value="2025-10-03">
                    </div>
                    <div>
                        <label class="input-label" for="notes">Notas</label>
                        <input type="text" id="notes" class="input-field" value="Los artículos pueden ser devueltos o reempla">
                    </div>
                </div>

                <div class="flex justify-center sm:justify-end flex-wrap gap-4 pt-6">
                    <button type="button" class="px-8 py-3 rounded-xl font-semibold secondary-button w-full sm:w-auto">Cancelar</button>
                    <button type="button" class="px-8 py-3 rounded-xl font-semibold text-white purr-button w-full sm:w-auto" onclick="generateFinalInvoice()">Generar Factura</button>
                </div>
            </form>
        </div>
    </div>
            <div class="mt-8 hidden invoice-preview" id="invoice-preview">
                <div class="invoice-container bg-white shadow-lg">
                    <!-- Header de la factura -->
                    <div class="border-b-2 border-orange-500 p-6">
                        <div class="flex justify-between items-start">
                            <div>
                                <h1 class="text-2xl font-bold text-orange-600">invoice</h1>
                                <p class="text-sm text-gray-600 mt-1">Detalles finales del pedido <span id="preview-order-number">#111-0592955-2893840</span></p>
                                <a href="#" class="text-blue-600 text-sm underline">Imprima esta página para sus registros.</a>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-600">Pedido realizado: <span id="preview-order-date">23 de mayo de 2020</span></p>
                                <p class="text-sm text-gray-600">Número de pedido: <span id="preview-order-number-2">#111-0592955-2893840</span></p>
                                <p class="text-sm font-semibold">Total del pedido: <span id="preview-total">$65.99</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Información de envío -->
                    <div class="p-6 border-b border-gray-200">
                        <div class="grid grid-cols-1 gap-8">
                            <div>
                                <h3 class="font-semibold text-gray-900 mb-2">Enviado el <span id="preview-ship-date">26 de mayo de 2020</span></h3>
                                <h4 class="font-semibold text-gray-900 mb-3">Productos comprados:</h4>
                                <div id="preview-products" class="space-y-3">
                                    <!-- Los productos se insertarán aquí dinámicamente -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Información de pago -->
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="font-semibold text-gray-900 mb-4">Información de pago</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-2">Método de pago:</h4>
                                <p class="text-sm text-gray-700">Visa | Últimos dígitos: 6571</p>
                                
                                <h4 class="font-semibold text-gray-900 mb-2 mt-6">Dirección de envío:</h4>
                                <div id="preview-shipping-address" class="text-sm text-gray-700 space-y-1">
                                    <p id="preview-customer-name">Cliente</p>
                                    <p id="preview-address-line">Dirección</p>
                                    <p id="preview-city-state-zip">Ciudad, Estado CP</p>
                                    <p id="preview-country">País</p>
                                </div>
                                
                                <div class="mt-4">
                                    <h4 class="font-semibold text-gray-900 mb-2">Velocidad de envío:</h4>
                                    <p class="text-sm text-gray-700" id="preview-shipping-method">Envío GRATIS</p>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-2">Resumen del pedido:</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span>Productos:</span>
                                        <span id="preview-subtotal">$65.99</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Envío:</span>
                                        <span id="preview-shipping-total">$10.60</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Envío gratis:</span>
                                        <span id="preview-shipping-discount">-$10.60</span>
                                    </div>
                                    <div class="border-t border-gray-300 pt-2 flex justify-between font-semibold">
                                        <span>Total antes de impuestos:</span>
                                        <span id="preview-pre-tax">$65.99</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Impuestos:</span>
                                        <span id="preview-tax">$0.00</span>
                                    </div>
                                    <div class="border-t border-gray-300 pt-2 flex justify-between font-bold text-lg text-red-600">
                                        <span>Total (I.V.A. Incluido):</span>
                                        <span id="preview-final-total">$65.99</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Transacciones -->
                    <div class="p-6">
                        <h3 class="font-semibold text-gray-900 mb-2">Transacciones con la tarjeta de crédito</h3>
                        <p class="text-sm text-gray-700">Visa que termina en 6571: <span id="preview-transaction-date">26 de mayo de 2020</span>: <span id="preview-transaction-amount">$65.99</span></p>
                        
                        <div class="mt-6 text-center">
                            <p class="text-sm text-gray-600">Gracias por su compra.</p>
                        </div>
                        
                        <div id="notesSection" class="mt-6 hidden">
                            <h4 class="font-semibold text-gray-900 mb-2">Notas Adicionales:</h4>
                            <p class="text-sm text-gray-700" id="notesContent"></p>
                        </div>
                    </div>

                    <!-- Botón de descarga -->
                    <div class="p-6 bg-gray-50 text-center print-hidden">
                        <button id="download-pdf" class="primary-button rounded font-medium flex items-center justify-center gap-2 mx-auto">
                            <span class="material-symbols-outlined">download</span>
                            <span>Descargar PDF</span>
                        </button>
                    </div>
                </div>
            </div>
        
        <!-- Bloque de anuncios AdSense -->
        <div class="mt-12 mb-8 flex justify-center w-full max-w-4xl mx-auto">
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-1897264775520223"
                 data-ad-slot="2473509960"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
            <script>
                 (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
        </div>
    </main>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        const jsonInput = document.getElementById('json-input');
        const invoicePreview = document.getElementById('invoice-preview');

        function showStatus(message, type = 'success') {
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            setTimeout(() => {
                if (type === 'success') {
                    statusDiv.style.display = 'none';
                }
            }, 3000);
        }

        function copyJsonToClipboard() {
            // El prompt exacto que se debe copiar
            const aiPrompt = `Actúa como especialista en digitalización de facturas.

Recibirás una o varias imágenes o archivos PDF de una misma factura.

Analiza todo el material y fusiona la información en un único resultado coherente.

Responde ÚNICAMENTE con un JSON válido siguiendo este formato:

{
  "numero_pedido": "",
  "fecha_pedido_iso": "AAAA-MM-DD",
  "fecha_envio_iso": "AAAA-MM-DD",
  "datos_cliente": {
    "nombre": "",
    "direccion": "",
    "ciudad": "",
    "estado": "",
    "codigo_postal": "",
    "pais": "Estados Unidos"
  },
  "metodo_envio": "",
  "productos": [
    {
      "descripcion": "",
      "cantidad": 0,
      "precio_unitario": 0.00,
      "moneda": "USD",
      "subtotal": 0.00
    }
  ],
  "totales": {
    "subtotal": 0.00,
    "envio": 0.00,
    "descuento_envio": 0.00,
    "impuestos": 0.00,
    "total": 0.00,
    "moneda": "USD"
  },
  "notas": ""
}

Reglas

Incluye todos los campos, aunque debas inferir o estimar valores plausibles.

Unifica los datos de todas las imágenes o archivos en un único JSON.

Usa el formato ISO AAAA-MM-DD para las fechas.

Emplea punto como separador decimal y dos decimales en importes monetarios.

Los impuestos siempre son 0 y el envío siempre es 0, a menos que en la factura adjunta se indique expresamente que se cobró algo.

La dirección de envío (pais) debe ser "Estados Unidos" por defecto si no está especificada. Los demás campos de la dirección deben dejarse en blanco si no aparecen en la factura.

El campo "notas" debe quedar en blanco si no hay información adicional relevante.`;
            
            navigator.clipboard.writeText(aiPrompt).then(() => {
                showStatus('✅ Prompt copiado al portapapeles', 'success');
            }).catch(() => {
                // Fallback para navegadores sin soporte clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = aiPrompt;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showStatus('✅ Prompt copiado al portapapeles', 'success');
            });
        }

        function formatCurrency(amount, currency = 'USD') {
            const symbols = {
                'USD': '$',
                'EUR': '€',
                'MXN': '$'
            };
            const symbol = symbols[currency] || '$';
            return `${symbol}${Number(amount || 0).toFixed(2)}`;
        }

        function formatDate(isoDate) {
            if (!isoDate) return '-';
            try {
                const date = new Date(isoDate);
                return date.toLocaleDateString('es-ES', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric' 
                });
            } catch (error) {
                return isoDate;
            }
        }

        function generateFinalInvoicePreview(editedData) {
            // Llenar información del pedido
            document.getElementById('preview-order-number').textContent = editedData.numero_pedido || '-';
            document.getElementById('preview-order-number-2').textContent = editedData.numero_pedido || '-';
            document.getElementById('preview-order-date').textContent = formatDate(editedData.fecha_pedido_iso);
            document.getElementById('preview-ship-date').textContent = formatDate(editedData.fecha_envio_iso);
            document.getElementById('preview-transaction-date').textContent = formatDate(editedData.fecha_envio_iso);
            
            // Método de envío
            const shippingMethods = {
                'Standard (Amazon - Elefama)': 'Envío Estándar',
                'gratis': 'Envío GRATIS',
                'standard': 'Envío Estándar', 
                'express': 'Envío Express'
            };
            document.getElementById('preview-shipping-method').textContent = 
                shippingMethods[editedData.metodo_envio] || editedData.metodo_envio || 'Envío GRATIS';
            
            // Llenar datos del cliente
            const cliente = editedData.datos_cliente || {};
            document.getElementById('preview-customer-name').textContent = cliente.nombre || '-';
            document.getElementById('preview-address-line').textContent = cliente.direccion || '-';
            document.getElementById('preview-city-state-zip').textContent = 
                [cliente.ciudad, cliente.estado, cliente.codigo_postal].filter(Boolean).join(', ');
            document.getElementById('preview-country').textContent = cliente.pais || '-';
            
            // Llenar productos 
            const productsContainer = document.getElementById('preview-products');
            productsContainer.innerHTML = '';
            
            if (editedData.productos && editedData.productos.length > 0) {
                editedData.productos.forEach(producto => {
                    const productDiv = document.createElement('div');
                    productDiv.className = 'border-b border-gray-200 pb-2 mb-2 last:border-b-0';
                    productDiv.innerHTML = `
                        <p class="text-sm"><strong>${producto.cantidad || 1}</strong> de: <strong>${producto.descripcion || 'Producto'}</strong></p>
                        <p class="text-sm font-semibold text-right">${formatCurrency(producto.subtotal || (producto.cantidad * producto.precio_unitario), producto.moneda)}</p>
                        <p class="text-xs text-gray-500">Estado: Nuevo</p>
                    `;
                    productsContainer.appendChild(productDiv);
                });
            } else {
                productsContainer.innerHTML = '<div class="text-center text-gray-500">No hay productos</div>';
            }
            
            // Llenar totales
            const totales = editedData.totales || {};
            const currency = totales.moneda || 'USD';
            
            document.getElementById('preview-subtotal').textContent = formatCurrency(totales.subtotal, currency);
            document.getElementById('preview-shipping-total').textContent = totales.envio > 0 ? 
                formatCurrency(totales.envio, currency) : '$10.60';
            document.getElementById('preview-shipping-discount').textContent = totales.descuento_envio > 0 ? 
                `-${formatCurrency(totales.descuento_envio, currency)}` : (totales.envio > 0 ? '$0.00' : '-$10.60');
            document.getElementById('preview-pre-tax').textContent = formatCurrency(totales.subtotal, currency);
            document.getElementById('preview-tax').textContent = formatCurrency(totales.impuestos, currency);
            document.getElementById('preview-total').textContent = formatCurrency(totales.total, currency);
            document.getElementById('preview-final-total').textContent = formatCurrency(totales.total, currency);
            document.getElementById('preview-transaction-amount').textContent = formatCurrency(totales.total, currency);
            
            // Llenar notas si existen
            const notesSection = document.getElementById('notesSection');
            const notesContent = document.getElementById('notesContent');
            
            if (editedData.notas && editedData.notas.trim()) {
                notesContent.textContent = editedData.notas;
                notesSection.classList.remove('hidden');
            } else {
                notesSection.classList.add('hidden');
            }
            
            // Ocultar formulario editable y mostrar la factura
            document.getElementById('editableForm').classList.add('hidden');
            invoicePreview.classList.remove('hidden');
            showStatus('✅ Factura final generada exitosamente', 'success');
            
            // Scroll a la factura
            setTimeout(() => {
                invoicePreview.scrollIntoView({ behavior: 'smooth' });
            }, 500);
        }



        function fillEditableForm(jsonData) {
            // Información básica
            document.getElementById('order-number').value = jsonData.numero_pedido || '';
            
            // Manejar fechas vacías o en formato template
            const fechaPedido = jsonData.fecha_pedido_iso;
            const fechaEnvio = jsonData.fecha_envio_iso;
            
            if (!fechaPedido || fechaPedido === 'AAAA-MM-DD' || fechaPedido.trim() === '') {
                // Fecha de pedido: 2 días atrás
                const hace2Dias = new Date();
                hace2Dias.setDate(hace2Dias.getDate() - 2);
                document.getElementById('order-date').value = hace2Dias.toISOString().split('T')[0];
            } else {
                document.getElementById('order-date').value = fechaPedido;
            }
            
            if (!fechaEnvio || fechaEnvio === 'AAAA-MM-DD' || fechaEnvio.trim() === '') {
                // Fecha de envío: 1 día atrás
                const hace1Dia = new Date();
                hace1Dia.setDate(hace1Dia.getDate() - 1);
                document.getElementById('delivery-date').value = hace1Dia.toISOString().split('T')[0];
            } else {
                document.getElementById('delivery-date').value = fechaEnvio;
            }
            
            // Datos del cliente
            const cliente = jsonData.datos_cliente || {};
            document.getElementById('client-name').value = cliente.nombre || '';
            document.getElementById('direccion').value = cliente.direccion || '';
            document.getElementById('ciudad').value = cliente.ciudad || '';
            document.getElementById('estado').value = cliente.estado || '';
            document.getElementById('codigo-postal').value = cliente.codigo_postal || '';
            document.getElementById('pais').value = cliente.pais || '';
            
            // Método de envío y costos
            document.getElementById('shipping-method').value = jsonData.metodo_envio || '';
            const totales = jsonData.totales || {};
            document.getElementById('shipping-cost').value = totales.envio || 0;
            
            // Notas
            document.getElementById('notes').value = jsonData.notas || '';
            
            // Cargar productos del JSON
            llenarProductosDesdeJSON(jsonData.productos || []);
        }

        function llenarProductosDesdeJSON(productos) {
            const container = document.getElementById('productos-container');
            
            // Limpiar productos existentes
            container.innerHTML = '';
            
            // Si no hay productos en el JSON, agregar una fila vacía
            if (!productos || productos.length === 0) {
                agregarProducto();
                return;
            }
            
            // Agregar cada producto del JSON
            productos.forEach(producto => {
                const nuevaFila = document.createElement('div');
                nuevaFila.className = 'grid grid-cols-1 md:grid-cols-5 gap-4 producto-row';
                nuevaFila.innerHTML = `
                    <input type="text" class="input-field md:col-span-3 producto-nombre" placeholder="Nombre del producto" value="${producto.descripcion || ''}">
                    <input type="number" class="input-field producto-cantidad" placeholder="Cantidad" value="${producto.cantidad || 1}" min="1">
                    <div class="flex items-center space-x-2">
                        <input type="number" class="input-field producto-precio" placeholder="Precio" value="${producto.precio_unitario || 0}" min="0" step="0.01">
                        <button type="button" class="text-gray-400 hover:text-red-500 eliminar-producto" onclick="eliminarProducto(this)">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                    </div>
                `;
            container.appendChild(nuevaFila);
        });
    }

    function mostrarCampoSiNoEsDefecto(valor, valorDefecto) {
        if (!valor || valor.trim() === '' || valor === valorDefecto) {
            return '';
        }
        return `<p>${valor}</p>`;
    }

    function mostrarDireccionCompleta(cliente) {
        const ciudad = cliente.ciudad && cliente.ciudad !== 'Ciudad Desconocida' ? cliente.ciudad : '';
        const estado = cliente.estado && cliente.estado !== 'Estado Desconocido' ? cliente.estado : '';
        const codigoPostal = cliente.codigo_postal && cliente.codigo_postal !== '00000' ? cliente.codigo_postal : '';
        
        // Solo mostrar si al menos uno de los campos tiene datos válidos
        if (ciudad || estado || codigoPostal) {
            const partes = [];
            if (ciudad) partes.push(ciudad);
            if (estado) partes.push(estado);
            if (codigoPostal) partes.push(codigoPostal);
            return `<p>${partes.join(', ')}</p>`;
        }
        return '';
    }        function fillEditableProducts(productos) {
            const container = document.getElementById('edit-products-list');
            container.innerHTML = '';
            
            if (productos.length === 0) {
                // Si no hay productos, agregar uno vacío
                addEditProduct();
            } else {
                productos.forEach((producto, index) => {
                    addEditProduct(producto, index);
                });
            }
        }

        function addEditProduct(producto = null, index = null) {
            const container = document.getElementById('edit-products-list');
            const productIndex = index !== null ? index : container.children.length;
            
            const productDiv = document.createElement('div');
            productDiv.className = 'grid grid-cols-12 gap-4 items-end p-4 bg-gray-50 rounded-lg edit-product-row';
            productDiv.innerHTML = `
                <div class="col-span-12 md:col-span-5">
                    <label class="input-label">Descripción del Producto</label>
                    <input class="input-field bg-white" type="text" name="edit-product-description" placeholder="Descripción del producto" value="${producto ? producto.descripcion || '' : ''}"/>
                </div>
                <div class="col-span-6 md:col-span-2">
                    <label class="input-label">Cantidad</label>
                    <input class="input-field bg-white" type="number" name="edit-product-quantity" min="1" placeholder="1" value="${producto ? producto.cantidad || 1 : 1}"/>
                </div>
                <div class="col-span-6 md:col-span-3">
                    <label class="input-label">Precio ($)</label>
                    <input class="input-field bg-white" type="number" name="edit-product-price" step="0.01" min="0" placeholder="0.00" value="${producto ? producto.precio_unitario || 0 : 0}"/>
                </div>
                <div class="col-span-12 md:col-span-2 flex justify-end">
                    <button type="button" onclick="removeEditProduct(this)" class="text-gray-400 hover:text-red-500 transition-colors duration-200 ${container.children.length === 0 ? 'hidden' : ''}">
                        <span class="material-symbols-outlined">delete</span>
                    </button>
                </div>
            `;
            
            container.appendChild(productDiv);
            updateEditProductButtons();
        }

        function removeEditProduct(button) {
            const container = document.getElementById('edit-products-list');
            if (container.children.length > 1) {
                button.closest('.edit-product-row').remove();
                updateEditProductButtons();
            }
        }

        function updateEditProductButtons() {
            const container = document.getElementById('edit-products-list');
            const deleteButtons = container.querySelectorAll('button[onclick="removeEditProduct(this)"]');
            
            deleteButtons.forEach(button => {
                if (container.children.length <= 1) {
                    button.classList.add('hidden');
                } else {
                    button.classList.remove('hidden');
                }
            });
        }

        function cancelEdit() {
            location.reload();
        }

        function agregarProducto() {
            const container = document.getElementById('productos-container');
            const nuevaFila = document.createElement('div');
            nuevaFila.className = 'grid grid-cols-1 md:grid-cols-5 gap-4 producto-row';
            nuevaFila.innerHTML = `
                <input type="text" class="input-field md:col-span-3 producto-nombre" placeholder="Nombre del producto">
                <input type="number" class="input-field producto-cantidad" placeholder="Cantidad" value="1" min="1">
                <div class="flex items-center space-x-2">
                    <input type="number" class="input-field producto-precio" placeholder="Precio" min="0" step="0.01">
                    <button type="button" class="text-gray-400 hover:text-red-500 eliminar-producto" onclick="eliminarProducto(this)">
                        <span class="material-symbols-outlined">delete</span>
                    </button>
                </div>
            `;
            container.appendChild(nuevaFila);
        }

        function eliminarProducto(boton) {
            const fila = boton.closest('.producto-row');
            const container = document.getElementById('productos-container');
            
            // No permitir eliminar si solo hay una fila
            if (container.children.length > 1) {
                fila.remove();
            } else {
                showStatus('❌ Debe mantener al menos un producto', 'error');
            }
        }

        function generateFinalInvoice() {
            // Recopilar datos del formulario editable
            const editedData = {
                numero_pedido: document.getElementById('order-number').value,
                fecha_pedido: document.getElementById('order-date').value,
                fecha_envio: document.getElementById('delivery-date').value,
                datos_cliente: {
                    nombre: document.getElementById('client-name').value,
                    direccion: document.getElementById('direccion').value,
                    ciudad: document.getElementById('ciudad').value,
                    estado: document.getElementById('estado').value,
                    codigo_postal: document.getElementById('codigo-postal').value,
                    pais: document.getElementById('pais').value
                },
                metodo_envio: document.getElementById('shipping-method').value,
                productos: [],
                totales: {
                    envio: parseFloat(document.getElementById('shipping-cost').value) || 0,
                    moneda: 'USD'
                },
                notas: document.getElementById('notes').value
            };
            
            // Recopilar productos del formulario
            const productRows = document.querySelectorAll('.producto-row');
            let subtotal = 0;
            
            productRows.forEach(row => {
                const nombre = row.querySelector('.producto-nombre').value.trim();
                const cantidad = parseInt(row.querySelector('.producto-cantidad').value) || 0;
                const precio = parseFloat(row.querySelector('.producto-precio').value) || 0;
                
                if (nombre && cantidad > 0 && precio > 0) {
                    const productSubtotal = cantidad * precio;
                    editedData.productos.push({
                        nombre: nombre,
                        cantidad: cantidad,
                        precio: precio
                    });
                    subtotal += productSubtotal;
                }
            });
            
            // Calcular totales
            editedData.totales.subtotal = subtotal;
            editedData.totales.descuento_envio = 0;
            editedData.totales.impuestos = 0;
            editedData.totales.total = subtotal + editedData.totales.envio;
            
            if (editedData.productos.length === 0) {
                showStatus('❌ Debe agregar al menos un producto válido', 'error');
                return;
            }
            
            // Generar PDF directamente
            generateAndDownloadPDF(editedData);
        }

        function generateAndDownloadPDF(data) {
            // Crear elemento temporal para la factura
            const tempInvoice = document.createElement('div');
            tempInvoice.className = 'invoice-preview';
            tempInvoice.style.position = 'absolute';
            tempInvoice.style.left = '-9999px';
            tempInvoice.style.top = '0';
            
            // Calcular totales
            const subtotal = data.productos.reduce((sum, prod) => sum + (prod.precio * prod.cantidad), 0);
            const total = subtotal + data.totales.envio;
            
            tempInvoice.innerHTML = `
                <div class="invoice-container bg-white shadow-lg">
                    <!-- Header de la factura -->
                    <div class="border-b-2 border-orange-500 p-6">
                        <div class="flex justify-between items-start">
                            <div>
                                <h1 class="text-2xl font-bold text-orange-600">invoice</h1>
                                <p class="text-sm text-gray-600 mt-1">Detalles finales del pedido <span>${data.numero_pedido}</span></p>
                                <a href="#" class="text-blue-600 text-sm underline">Imprima esta página para sus registros.</a>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-600">Pedido realizado: <span>${data.fecha_pedido}</span></p>
                                <p class="text-sm text-gray-600">Número de pedido: <span>${data.numero_pedido}</span></p>
                                <p class="text-sm font-semibold">Total del pedido: <span>$${total.toFixed(2)}</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Información de envío -->
                    <div class="p-6 border-b border-gray-200">
                        <div class="grid grid-cols-1 gap-8">
                            <div>
                                <h3 class="font-semibold text-gray-900 mb-2">Enviado el <span>${data.fecha_envio}</span></h3>
                                <h4 class="font-semibold text-gray-900 mb-3">Productos comprados:</h4>
                                <div class="space-y-3">
                                    ${data.productos.map(producto => `
                                        <div class="flex justify-between items-center border-b border-gray-100 pb-2">
                                            <div class="flex-1">
                                                <p class="text-sm font-medium text-gray-900">${producto.nombre}</p>
                                                <p class="text-xs text-gray-600">Cantidad: ${producto.cantidad}</p>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-sm font-semibold text-gray-900">$${(producto.precio * producto.cantidad).toFixed(2)}</p>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Información de pago -->
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="font-semibold text-gray-900 mb-4">Información de pago</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-2">Método de pago:</h4>
                                <p class="text-sm text-gray-700">Visa | Últimos dígitos: 6571</p>
                                
                                <h4 class="font-semibold text-gray-900 mb-2 mt-6">Dirección de envío:</h4>
                                <div class="text-sm text-gray-700 space-y-1">
                                    <p>${data.datos_cliente.nombre}</p>
                                    ${mostrarCampoSiNoEsDefecto(data.datos_cliente.direccion, 'Dirección Desconocida')}
                                    ${mostrarDireccionCompleta(data.datos_cliente)}
                                    ${mostrarCampoSiNoEsDefecto(data.datos_cliente.pais, 'País Desconocido')}
                                </div>
                                
                                <div class="mt-4">
                                    <h4 class="font-semibold text-gray-900 mb-2">Velocidad de envío:</h4>
                                    <p class="text-sm text-gray-700">${data.metodo_envio}</p>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-2">Resumen del pedido:</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span>Productos:</span>
                                        <span>$${subtotal.toFixed(2)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Envío:</span>
                                        <span>$${data.totales.envio.toFixed(2)}</span>
                                    </div>
                                    <div class="flex justify-between font-semibold pt-2 border-t border-gray-200">
                                        <span>Total:</span>
                                        <span class="text-orange-600">$${total.toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${data.notas ? `<div class="mt-6"><h4 class="font-semibold text-gray-900 mb-2">Notas:</h4><p class="text-sm text-gray-700">${data.notas}</p></div>` : ''}
                    </div>
                </div>
            `;
            
            document.body.appendChild(tempInvoice);
            
            // Generar PDF
            if (typeof window.jspdf === 'undefined' && typeof window.jsPDF === 'undefined') {
                showStatus('❌ Librería PDF no disponible', 'error');
                document.body.removeChild(tempInvoice);
                return;
            }

            if (typeof html2canvas === 'undefined') {
                showStatus('❌ Librería html2canvas no disponible', 'error');
                document.body.removeChild(tempInvoice);
                return;
            }

            try {
                const { jsPDF } = window.jspdf || window;
                const invoiceElement = tempInvoice.querySelector('.invoice-container');
                
                html2canvas(invoiceElement, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 210; // A4 width in mm
                    const pageHeight = 295; // A4 height in mm
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    let heightLeft = imgHeight;
                    
                    let position = 0;
                    
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    const orderNumber = data.numero_pedido.replace(/[^a-zA-Z0-9]/g, '') || 'factura';
                    const fileName = `factura-${orderNumber}-${new Date().toISOString().slice(0, 10)}.pdf`;
                    pdf.save(fileName);
                    
                    showStatus('✅ PDF descargado exitosamente', 'success');
                    
                    // Limpiar y recargar
                    document.body.removeChild(tempInvoice);
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                    
                }).catch(error => {
                    console.error('Error al generar PDF:', error);
                    showStatus(`❌ Error al generar PDF: ${error.message}`, 'error');
                    document.body.removeChild(tempInvoice);
                });

            } catch (error) {
                console.error('Error:', error);
                showStatus(`❌ Error: ${error.message}`, 'error');
                document.body.removeChild(tempInvoice);
            }
        }

        function downloadPDF() {
            if (invoicePreview.classList.contains('hidden')) {
                showStatus('❌ Primero genera la factura', 'error');
                return;
            }

            if (typeof window.jspdf === 'undefined' && typeof window.jsPDF === 'undefined') {
                showStatus('❌ Librería PDF no disponible', 'error');
                return;
            }

            if (typeof html2canvas === 'undefined') {
                showStatus('❌ Librería html2canvas no disponible', 'error');
                return;
            }

            try {
                const { jsPDF } = window.jspdf || window;
                const invoiceElement = document.querySelector('.invoice-container');
                
                html2canvas(invoiceElement, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 210; // A4 width in mm
                    const pageHeight = 295; // A4 height in mm
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    let heightLeft = imgHeight;
                    
                    let position = 0;
                    
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    const orderNumber = document.getElementById('preview-order-number').textContent.replace(/[^a-zA-Z0-9]/g, '') || 'factura';
                    const fileName = `factura-${orderNumber}-${new Date().toISOString().slice(0, 10)}.pdf`;
                    pdf.save(fileName);
                    
                    showStatus('✅ PDF descargado exitosamente', 'success');
                }).catch(error => {
                    console.error('Error al generar PDF:', error);
                    showStatus(`❌ Error al generar PDF: ${error.message}`, 'error');
                });

            } catch (error) {
                console.error('Error:', error);
                showStatus(`❌ Error: ${error.message}`, 'error');
            }
        }

        function printInvoice() {
            if (invoicePreview.classList.contains('hidden')) {
                showStatus('❌ Primero genera la factura', 'error');
                return;
            }
            
            window.print();
        }

        // Animación inicial
        document.addEventListener('DOMContentLoaded', () => {
            const step1 = document.getElementById('form-step-1');
            const step2 = document.getElementById('form-step-2');
            const generateButton = document.getElementById('generate-button');

            // Animación inicial para mostrar el primer formulario
            gsap.to(step1, {
                duration: 0.8,
                opacity: 1,
                y: 0,
                ease: 'power3.out',
                delay: 0.2
            });

            // Evento para el botón que inicia la transición
            generateButton.addEventListener('click', () => {
                try {
                    const jsonData = JSON.parse(document.getElementById('json-input').value.trim());
                    
                    // Animar la salida del primer formulario
                    gsap.to(step1, {
                        duration: 0.5,
                        opacity: 0,
                        scale: 0.98,
                        ease: 'power2.in',
                        onComplete: () => {
                            step1.classList.add('hidden');
                            
                            // Llenar el formulario editable con los datos del JSON
                            fillEditableForm(jsonData);
                            
                            // Mostrar el segundo paso
                            step2.classList.remove('hidden');
                            
                            // Animar la entrada del segundo formulario DESPUÉS de ocultar el primero
                            gsap.fromTo(step2, {
                                opacity: 0,
                                y: 20
                            }, {
                                duration: 0.7,
                                opacity: 1,
                                y: 0,
                                ease: 'power3.out'
                            });
                            
                            showStatus('✅ Datos cargados en el formulario editable', 'success');
                        }
                    });
                } catch (error) {
                    showStatus(`❌ Error: JSON inválido - ${error.message}`, 'error');
                }
            });
        });

        // Event listener para descarga de PDF
        document.getElementById('download-pdf').addEventListener('click', downloadPDF);
    </script>
        
    <footer class="w-full max-w-4xl py-8 mt-12 text-center text-sm text-[var(--text-muted-color)]">
        <div class="flex justify-center space-x-6 mb-4">
            <a class="hover:text-[var(--accent-color)] transition-colors" href="terminos.html">Términos y Condiciones</a>
            <a class="hover:text-[var(--accent-color)] transition-colors" href="privacidad.html">Privacidad</a>
        </div>
        <p>© 2025 PurrCrafter. Todos los derechos reservados.</p>
    </footer>
</div>

</body>
</html>