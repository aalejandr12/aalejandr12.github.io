<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Triple Test API - PurrCrafter</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto bg-white rounded-lg shadow-md p-6">
        <h1 class="text-3xl font-bold mb-6 text-center">üî• Triple Test API - PurrCrafter</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <!-- Test 1: Localhost -->
            <div class="border rounded-lg p-4 bg-blue-50">
                <h3 class="text-lg font-semibold mb-3 text-blue-800">üè† Test 1: Localhost</h3>
                <div class="space-y-2 text-sm">
                    <p><strong>URL:</strong> http://localhost:3002</p>
                    <p><strong>Tipo:</strong> Conexi√≥n directa local</p>
                    <p><strong>Estado:</strong> <span id="localhost-status" class="px-2 py-1 rounded text-xs bg-gray-100">‚ùì No probado</span></p>
                    <button id="test-localhost" class="w-full bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 mt-2">
                        üß™ Probar Localhost
                    </button>
                </div>
            </div>
            
            <!-- Test 2: HTTPS IP Directa -->
            <div class="border rounded-lg p-4 bg-orange-50">
                <h3 class="text-lg font-semibold mb-3 text-orange-800">üåê Test 2: HTTPS IP</h3>
                <div class="space-y-2 text-sm">
                    <p><strong>URL:</strong> https://190.150.201.118</p>
                    <p><strong>Tipo:</strong> HTTPS con IP directa</p>
                    <p><strong>Estado:</strong> <span id="https-ip-status" class="px-2 py-1 rounded text-xs bg-gray-100">‚ùì No probado</span></p>
                    <button id="test-https-ip" class="w-full bg-orange-500 text-white py-2 px-4 rounded hover:bg-orange-600 mt-2">
                        üîí Probar HTTPS IP
                    </button>
                </div>
            </div>
            
            <!-- Test 3: HTTPS Dominio -->
            <div class="border rounded-lg p-4 bg-green-50">
                <h3 class="text-lg font-semibold mb-3 text-green-800">üèÜ Test 3: HTTPS Dominio</h3>
                <div class="space-y-2 text-sm">
                    <p><strong>URL:</strong> https://api-oculto-9k7s.aaleddy.app</p>
                    <p><strong>Tipo:</strong> HTTPS con dominio SSL</p>
                    <p><strong>Estado:</strong> <span id="https-domain-status" class="px-2 py-1 rounded text-xs bg-gray-100">‚ùì No probado</span></p>
                    <button id="test-https-domain" class="w-full bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 mt-2">
                        üöÄ Probar HTTPS Dominio
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Informaci√≥n del entorno -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
            <h3 class="font-semibold text-yellow-800 mb-2">üìã Informaci√≥n del Entorno:</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div>
                    <p><strong>Hostname:</strong> <span id="current-hostname"></span></p>
                    <p><strong>Protocolo:</strong> <span id="current-protocol"></span></p>
                </div>
                <div>
                    <p><strong>User Agent:</strong> <span id="user-agent"></span></p>
                    <p><strong>Timestamp:</strong> <span id="timestamp"></span></p>
                </div>
                <div>
                    <p><strong>DNS Propagado:</strong> ‚úÖ S√≠ (verificado)</p>
                    <p><strong>IP P√∫blica:</strong> 190.150.201.118</p>
                </div>
            </div>
        </div>
        
        <!-- Bot√≥n para probar todos -->
        <div class="text-center mb-6">
            <button id="test-all" class="bg-purple-600 text-white py-3 px-8 rounded-lg hover:bg-purple-700 text-lg font-semibold">
                üéØ Probar Todos los Endpoints
            </button>
        </div>
        
        <!-- Resultados de las pruebas -->
        <div id="test-results" class="space-y-4">
            <h3 class="text-xl font-semibold mb-4">üìä Resultados Detallados:</h3>
            <!-- Los resultados aparecer√°n aqu√≠ -->
        </div>
        
        <!-- Diagn√≥sticos avanzados -->
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mt-6">
            <h3 class="font-semibold text-gray-800 mb-2">üî¨ Diagn√≥sticos Avanzados:</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>
                    <h4 class="font-medium mb-1">Nginx Config:</h4>
                    <p>‚úÖ Proxy configurado para puerto 3002</p>
                    <p>‚úÖ SSL configurado con Let's Encrypt</p>
                    <p>‚úÖ CORS headers permitidos</p>
                </div>
                <div>
                    <h4 class="font-medium mb-1">Router Config:</h4>
                    <p>‚úÖ Puerto 80 ‚Üí 192.168.0.38:80</p>
                    <p>‚úÖ Puerto 443 ‚Üí 192.168.0.38:443</p>
                    <p>‚úÖ DNS apunta a IP p√∫blica</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // URLs para las pruebas
        const ENDPOINTS = {
            localhost: 'http://localhost:3002',
            httpsIP: 'https://190.150.201.118',
            httpsDomain: 'https://api-oculto-9k7s.aaleddy.app'
        };
        
        // Actualizar informaci√≥n del entorno
        function updateSystemInfo() {
            document.getElementById('current-hostname').textContent = window.location.hostname;
            document.getElementById('current-protocol').textContent = window.location.protocol;
            document.getElementById('user-agent').textContent = navigator.userAgent.split(' ')[0];
            document.getElementById('timestamp').textContent = new Date().toLocaleString();
        }
        
        // Actualizar estado de un test
        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            const colors = {
                testing: 'bg-yellow-100 text-yellow-800',
                success: 'bg-green-100 text-green-800',
                error: 'bg-red-100 text-red-800'
            };
            
            element.className = `px-2 py-1 rounded text-xs ${colors[status]}`;
            element.textContent = message;
        }
        
        // Agregar resultado de test
        function addTestResult(title, details, success, responseTime = null, extra = {}) {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            const bgColor = success ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
            const textColor = success ? 'text-green-800' : 'text-red-800';
            const icon = success ? '‚úÖ' : '‚ùå';
            
            let extraInfo = '';
            if (responseTime) {
                extraInfo += `\nTiempo de respuesta: ${responseTime}ms`;
            }
            if (extra.workspaceId) {
                extraInfo += `\nWorkspace ID: ${extra.workspaceId}`;
            }
            if (extra.headers) {
                extraInfo += `\nHeaders importantes: ${JSON.stringify(extra.headers, null, 2)}`;
            }
            
            resultDiv.className = `border rounded-lg p-4 ${bgColor}`;
            resultDiv.innerHTML = `
                <h4 class="font-semibold ${textColor} mb-2">${icon} ${title}</h4>
                <pre class="text-sm ${textColor} whitespace-pre-wrap">${details}${extraInfo}</pre>
                <p class="text-xs ${textColor} mt-2">Tiempo: ${new Date().toLocaleTimeString()}</p>
            `;
            
            resultsDiv.appendChild(resultDiv);
        }
        
        // Funci√≥n de test general
        async function testEndpoint(url, name, statusElementId) {
            updateStatus(statusElementId, 'testing', 'üîÑ Probando...');
            
            try {
                console.log(`Testing ${name} at: ${url}`);
                
                const startTime = Date.now();
                const response = await fetch(`${url}/workspaces`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    mode: 'cors'
                });
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Extraer headers importantes
                const importantHeaders = {};
                ['server', 'access-control-allow-origin', 'content-type'].forEach(header => {
                    if (response.headers.get(header)) {
                        importantHeaders[header] = response.headers.get(header);
                    }
                });
                
                updateStatus(statusElementId, 'success', '‚úÖ Conectado');
                addTestResult(
                    `${name} - Conexi√≥n Exitosa`,
                    `URL: ${url}\nStatus: ${response.status} ${response.statusText}\nRespuesta: ${JSON.stringify(data, null, 2)}`,
                    true,
                    responseTime,
                    { workspaceId: data.workspace_id, headers: importantHeaders }
                );
                
                return data;
                
            } catch (error) {
                console.error(`Error testing ${name}:`, error);
                updateStatus(statusElementId, 'error', '‚ùå Error');
                
                let errorDetails = `URL: ${url}\nError: ${error.message}`;
                
                // Detectar tipos espec√≠ficos de error
                if (error.message.includes('Failed to fetch')) {
                    errorDetails += '\nTipo: Error de red/CORS';
                } else if (error.message.includes('ERR_CERT')) {
                    errorDetails += '\nTipo: Error de certificado SSL';
                } else if (error.message.includes('ERR_NAME_NOT_RESOLVED')) {
                    errorDetails += '\nTipo: Error de DNS';
                }
                
                addTestResult(
                    `${name} - Error de Conexi√≥n`,
                    errorDetails,
                    false
                );
                
                return null;
            }
        }
        
        // Event listeners para botones individuales
        document.getElementById('test-localhost').addEventListener('click', () => {
            testEndpoint(ENDPOINTS.localhost, 'Localhost', 'localhost-status');
        });
        
        document.getElementById('test-https-ip').addEventListener('click', () => {
            testEndpoint(ENDPOINTS.httpsIP, 'HTTPS IP', 'https-ip-status');
        });
        
        document.getElementById('test-https-domain').addEventListener('click', () => {
            testEndpoint(ENDPOINTS.httpsDomain, 'HTTPS Dominio', 'https-domain-status');
        });
        
        // Event listener para probar todos
        document.getElementById('test-all').addEventListener('click', async () => {
            // Limpiar resultados anteriores
            document.getElementById('test-results').innerHTML = '<h3 class="text-xl font-semibold mb-4">üìä Resultados Detallados:</h3>';
            
            // Ejecutar todos los tests secuencialmente
            await testEndpoint(ENDPOINTS.localhost, 'Test 1: Localhost', 'localhost-status');
            await new Promise(resolve => setTimeout(resolve, 1000)); // Pausa de 1 segundo
            
            await testEndpoint(ENDPOINTS.httpsIP, 'Test 2: HTTPS IP', 'https-ip-status');
            await new Promise(resolve => setTimeout(resolve, 1000)); // Pausa de 1 segundo
            
            await testEndpoint(ENDPOINTS.httpsDomain, 'Test 3: HTTPS Dominio', 'https-domain-status');
        });
        
        // Inicializar
        updateSystemInfo();
        
        // Auto-test del localhost al cargar (solo si estamos en local)
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            setTimeout(() => {
                testEndpoint(ENDPOINTS.localhost, 'Localhost (auto)', 'localhost-status');
            }, 1000);
        }
    </script>
</body>
</html>